<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container py-5">
  <div class="card shadow p-4 mx-auto" style="max-width:600px;">
    <h1 class="h4 mb-4 text-center">Panel Admin</h1>
    <div class="d-flex gap-2 mb-3 justify-content-center">
      <button id="startBtn" class="btn btn-success">Iniciar Juego</button>
      <button id="nextBtn" class="btn btn-primary">Siguiente Foto</button>
    </div>
    <div id="status" class="mb-3 text-center"></div>
    <div id="photo" class="text-center"></div>
  </div>

  <!-- Modal para pantalla completa -->
  <div class="modal fade" id="imgModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
      <div class="modal-content bg-dark">
        <div class="modal-body d-flex justify-content-center align-items-center p-0">
          <img id="modalImg" class="img-fluid" alt="foto" style="max-height: 100vh;">
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="js/app.js"></script>
  <script>
    const user = JSON.parse(localStorage.getItem('user') || 'null');
    if (!user || user.role !== 'admin') {
      alert('Acceso solo para admin');
      window.location.href = 'login.html';
    }

    let currentPhotoId = null;

    document.getElementById('startBtn').addEventListener('click', async () => {
      const res = await fetch(`/api/game/start?userId=${user.id}`, { method: 'POST' });
      const data = await res.json();
      if (!res.ok) { alert(data.error); return; }
      alert(`Juego iniciado con ${data.total} fotos`);
    });

    document.getElementById('nextBtn').addEventListener('click', async () => {
      const res = await fetch(`/api/game/next?userId=${user.id}`);
      const data = await res.json();
      if (!res.ok) { alert(data.error); return; }
      if (data.done) {
        document.getElementById('status').innerText = data.message;
        document.getElementById('photo').innerHTML = '';
        return;
      }

      currentPhotoId = data.photoId;
      document.getElementById('status').innerText = `Quedan ${data.remaining}`;
      document.getElementById('photo').innerHTML = `
        <div class="d-flex flex-column align-items-center gap-2">
          <img id="gamePhoto" src="/api/image/${data.photoId}?userId=${user.id}" 
              class="img-fluid rounded shadow" style="max-width:300px; cursor:pointer">
          <button id="deleteBtn" class="btn btn-danger btn-sm">Borrar Foto</button>
        </div>
      `;

      // Click para abrir modal
      document.getElementById('gamePhoto').addEventListener('click', () => {
        document.getElementById('modalImg').src = `/api/image/${data.photoId}?userId=${user.id}`;
        const modal = new bootstrap.Modal(document.getElementById('imgModal'));
        modal.show();
      });

      // Botón borrar
      document.getElementById('deleteBtn').addEventListener('click', async () => {
        if (!confirm("¿Seguro que quieres borrar esta foto?")) return;
        const resDel = await fetch(`/api/photos/${currentPhotoId}?userId=${user.id}`, { method: 'DELETE' });

        const result = await resDel.json();
        if (!resDel.ok) { alert(result.error); return; }
        alert("Foto eliminada con éxito");
        document.getElementById('photo').innerHTML = '';
        document.getElementById('status').innerText = "Foto eliminada";
      });
    });
  </script>
</body>
</html>
